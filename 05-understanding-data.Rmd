```{r loadEdSurvey5, echo=FALSE, message=FALSE}
library(EdSurvey)
path <- "I:/NCES/NCES_Dev/EdSurvey Project/DataSimulation/Deliverable/NCES2024013_UploadDate09232024/S46MAT/"
sdf <- readNAEP(path = file.path(path, "Data/M46NT2SM.dat"), frPath = file.path(path, "Select/Parms/M46NT2SM.fr2"))
```

# Understanding Data {#understandingData}

Last edited: July 2023

**Suggested Citation**<br></br>
Liao, Y. Understanding Data. In Bailey, P. and Zhang, T. (eds.), _Analyzing NCES Data Using EdSurvey: A User's Guide_.

Once data are successfully read in (see how `EdSurvey` supports reading-in data for each study in [Chapter 4](#dataAccess)), users can use the commands in the following sections to understand the data.

To follow along in this chapter, load the [NAEP Primer dataset](https://nces.ed.gov/pubsearch/pubsinfo.asp?pubid=2011463) `M36NT2PM` and assign it the name `sdf` with the following call:
```{r readIn}
sdf <- readNAEP(path = system.file("extdata/data", "M36NT2PM.dat", package = "NAEPprimer"))
```

## Searching Variables
The `colnames()` function will list all variable names in the data:

```{r colnames}
colnames(x = sdf)
```

To conduct a more powerful search of NAEP data variables, use the `searchSDF()` function, which returns variable names and labels from an `edsurvey.data.frame` based on a character string. The user can specify which data source (either "student" or "school") to search. For example, the following call to `searchSDF()` searches for the character string `"book"` in an `edsurvey.data.frame` and specifies the `fileFormat` to search the student data file:

```{r searchSDFB}
searchSDF(string = "book", data = sdf, fileFormat = "student")
```

The levels and labels for each variable searched via `searchSDF()` also can be returned by setting `levels = TRUE`:

```{r searchSDF1}
searchSDF(string = "book", data = sdf, fileFormat = "student", levels = TRUE)
```

The `|` (OR) operator will search several strings simultaneously:

```{r searchSDF2}
searchSDF(string="book|home|value", data=sdf)
```

A vector of strings will search for variables that contain multiple strings, such as both "book" and "home"; each string is present in the variable label and can be used to filter the results:

```{r searchSDF3}
searchSDF(string=c("book","home"), data=sdf)
```

To dive into a particular variable, use `levelsSDF()`. It returns the levels, the corresponding sample size, and label of each level.

```{r levelsSDF}
levelsSDF(varnames = "b017451", data = sdf)
```

## Displaying Basic Information

Some basic functions that work on a `data.frame`, such as `dim`, `nrow`, and `ncol`, also work on an `edsurvey.data.frame`. They help check the dimensions of `sdf`.


```{r dimensions, warning=FALSE}
dim(x = sdf)
nrow(x = sdf)
ncol(x = sdf)
```

Basic information about plausible values and weights in an `edsurvey.data.frame` can be seen in the `print` function. The variables associated with plausible values and weights can be seen from the `showPlausibleValues` and `showWeights` functions, respectively, when setting the `verbose` argument to `TRUE`:

```{r showPlausibleValues}
showPlausibleValues(data = sdf, verbose = TRUE)
showWeights(data = sdf, verbose = TRUE)
```

The functions `getStratumVar` and `getPSUVar` return the default stratum variable name or a PSU variable associated with a weight variable.

```{r getStratumVar}
getStratumVar(data = sdf, weightVar = "origwt")
getPSUVar(data = sdf, weightVar = "origwt")
```

##	Keeping or Removing Omitted Levels

`EdSurvey` uses listwise deletion to remove special values in all analyses by default. For example, in the NAEP Primer data, the omitted levels are returned when `print(sdf)` is called: `Omitted Levels: 'Multiple', 'NA', 'Omitted'`. By default, these levels are excluded via listwise deletion in `EdSurvey` analytical functions. To use a different method, such as pairwise deletion, set `defaultConditions = FALSE` when running your analysis.

## Exploring Data
This section highlights three key R functions (`EdSurvey` and general R functions) often utilized during the exploration phase of data analysis:

1. **`summary2()`** generates descriptive statistics, both weighted and unweighted, for a given variable. 

2. **`edsurveyTable()`** creates cross-tabulation statistics.

3. **`ggplot2`** facilitates the creation of various exploratory data analysis (EDA) visualizations.


### `summary2()`
The **`summary2()`** function requires four main arguments:

- **`data`**: An `EdSurvey` object.
- **`variable`**: The variable name for which statistics are to be calculated.
- **`weightVar`**: Name of the weight variable or `NULL` if no weighting is required.
- **`dropOmittedLevels`**: If set as `TRUE`, levels marked as omitted are excluded from the calculations; if set as `FALSE`, they are included.

The `summary2` function enables the generation of both weighted and unweighted statistics, offering a helpful way to examine survey responses during the data exploration process. For datasets like NAEP, which have a default weight variable, weighted statistics are provided automatically. When the chosen variable consists of plausible values and a weight variable is supplied, the function incorporates plausible value pooling and weighting.


function produces both weighted and unweighted descriptive statistics for a variable. This functionality is quite useful for gathering response information for survey variables when conducting data exploration. For NAEP data and other datasets that have a default weight variable, `summary2` produces weighted statistics by default. If the specified variable is a set of plausible values, and the `weightVar` option is non-`NULL`, `summary2` statistics account for both plausible values pooling and weighting.

```{r summary2}
summary2(data = sdf, variable = "composite")
```

By setting `weightVar = NULL`, unweighted statistics are returned for the selected variable or plausible values:

```{r summary2Unweighted}
summary2(data = sdf, variable = "composite", weightVar = NULL)
```

For categorical variables, `summary2` provides weighted counts, weighted percentages, and their standard errors. For instance, the variable `b017451`, representing the frequency of student discussions about studies at home, yields the following:

```{r summary2Categorical}
summary2(data = sdf, variable = "b017451")
```

By default, omitted levels are included in the calculation; to remove omitted levels from the calculation and from the output, set `dropOmittedLevels = TRUE`:

```{r summary2Categoricalmitted}
summary2(data = sdf, variable = "b017451", dropOmittedLevels = TRUE)
```


### `edsurveyTable()`
The `edsurveyTable()` function is used to summarize outcome and categorical variables. It requires three primary arguments:

- **`formula`**: A formula written as `a ~ b + c`, where: 
  - **`a`** represents an optional continuous variable for calculating weighted means.
  - **`b`** and **`c`** are categorical variables for cross-tabulation. 
- **`data`**: An `EdSurvey` object.
- **`pctAggregationLevel`**: A numeric value (e.g., 0, 1, 2) indicating the level of percentage aggregation in the results. The default is set to `NULL` (or `1`). That is, the `PCT` column of the results adds up to 100 within each level of the first categorical variable `a`. 

The example below generates a summary table for the NAEP composite mathematics scores (`composite`) of 8th-grade students, categorized by gender (`dsex`) and frequency of discussing studies at home (`b017451`). Because `pctAggregationLevel` is set to be the default `NULL` (or `1`), the `PCT` column of the results adds up to 100 within each level of the first categorical variable, `dsex`.

```{r edsurveyTable1, eval=FALSE}
es1 <- edsurveyTable(formula = composite ~ dsex + b017451, data = sdf, pctAggregationLevel = NULL)
```

```{r table501, echo=FALSE}
library(knitr)
library(kableExtra)
library(EdSurvey)
sdf <- readNAEP(path = system.file("extdata/data", "M36NT2PM.dat", package = "NAEPprimer"))
es1 <- edsurveyTable(formula = composite ~ dsex + b017451, data = sdf, pctAggregationLevel = NULL)
kable(es1$data, format="html", caption = "Summary Data Tables with EdSurvey") %>%
  kable_styling(font_size = 16) %>%
  scroll_box(width="100%", height = "30%")
```

By setting `pctAggregationLevel = 0` (instead of the default `NULL` or `1`), the `PCT` column sums to 100 across the entire sample:

```{r edsurveyTable2}
es2 <- edsurveyTable(formula = composite ~ dsex + b017451, data = sdf, pctAggregationLevel = 0)
```

```{r table502, echo=FALSE}
library(knitr)
library(kableExtra)
library(EdSurvey)
sdf <- readNAEP(path = system.file("extdata/data", "M36NT2PM.dat", package = "NAEPprimer"))
es2 <- edsurveyTable(formula = composite ~ dsex + b017451, data = sdf, pctAggregationLevel = 0)
kable(es2$data, format="html", caption = "Summary Data Tables with EdSurvey, Setting pctAggregationLevel = 0 \\label{tab:table2}") %>%
  kable_styling(font_size = 16) %>%
  scroll_box(width="100%", height = "75%")
```

### `ggplot2`

The `ggplot2` package in R is widely used for data visualization. It can be used in conjunction with `EdSurvey` for exploratory data analysis (EDA). This section introduces a straightforward approach to EDA using `ggplot2` and `EdSurvey` functions. Note that the examples provided here do not use weights, and only one set of plausible values is used where applicable. For a deeper dive into EDA with NCES data, refer to [*Exploratory Data Analysis on NCES Data*](https://www.air.org/sites/default/files/EdSurvey-EDA.pdf).

```{r loadgg, message=FALSE}
# load the ggplot2 library
library(ggplot2)
```

Here are the main steps for creating visualizations with `ggplot2`. To learn more about how to use `ggplot2()`, please visit the [official ggplot2 website](https://ggplot2.tidyverse.org/). 

1. Start by initializing a plot using the `ggplot()` function.
2. Define the dataset and map aesthetic properties with `aes()`.
3. Add layers to the plot using a variety of functions, such as the following. The italicized functions are also featured in the code chunk examples below
- Geometries:  *`geom_bar()`*, *`geom_histogram()`*, *`geom_boxplot()`*
- Scales: `scale_colour_brewer()`, `scale_x_date()`
- Facets:  *`facet_grid()`*, `facet_wrap()`
- Statistical transformations: *`stat_summary()`*, `stat_density()`
- Coordinate systems: *`coord_flip()`*, `coord_map()`


The dataset used in the examples is stored in the `gddat` object:

```{r gddat}
gddat <- getData(data = sdf, varnames = c('dsex', 'sdracem', 'b018201', 'b017451',
                                   'composite', 'geometry', 'origwt'),
              addAttributes = TRUE, dropOmittedLevels = FALSE)
```           

####Bar Chart with `geom_bar()`
Bar charts represent data with rectangles whose heights indicate values. Figure 1 displays a bar chart showing counts of the variable `b017451` by category, with `fill = dsex` used to segment by gender (`dsex`).

```{r plot1, message=FALSE, fig.width=11,fig.height=3}
bar1 <- ggplot(data = gddat, aes(x = b017451)) +
  geom_bar(aes(fill = dsex)) +
  coord_flip() +
  labs(title = "Figure 1")
bar1
```

####Histogram with geom_histogram()
Histograms illustrate the distribution of continuous variables through binning. Figure 2 depicts the unweighted distribution of the first plausible value of the `composite` variable.

```{r plot2, message=FALSE, fig.width=11,fig.height=3}
hist1 <- ggplot(gddat, aes(x = mrpcm1)) +
    geom_histogram() + 
    labs(title = "Figure 2") 
hist1
``` 
Figure 3 builds on Figure 2 by faceting the histogram by `dsex`, producing two histograms with shared axes.

```{r plot3, message=FALSE, fig.width=11, fig.height=3}
hist2 <- ggplot(gddat, aes(x = mrpcm1)) +
  geom_histogram(color = "black", fill = "white")+
  facet_grid(dsex ~ .) +
  labs(title = "Figure 3") 
hist2
```

####Boxplot with geom_boxplot()
Boxplots summarize data distribution using quartiles. Figure 4 shows the distribution of `mrpcm1` (the first plausible value of `composite`) across the six categories of `sdracem.`

```{r plot4, message=FALSE, fig.width=11, fig.height=3}
box1 <- ggplot(gddat, aes(x = sdracem, y = mrpcm1)) + 
  geom_boxplot() +
  labs(title = "Figure 4") 
box1
``` 
Figure 5 enhances Figure 4 by overlaying mean values (diamond shapes) for each category using `stat_summary()` and flipping the coordinates with `coord_flip()`.

```{r plot5, message=FALSE, fig.width=11, fig.height=3, warning=FALSE}

box2 <- box1 + stat_summary(fun.y = mean, geom = "point", shape = 23, size = 4) +
  coord_flip() +
  labs(title = "Figure 5") 
box2
``` 
